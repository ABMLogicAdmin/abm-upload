<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ABM Logic – Workbench</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --brand-primary:#30ADF7;
      --brand-navy:#22233D;
      --brand-bg:#E6F6FF;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      font-family:Poppins,Arial,sans-serif;
      background:linear-gradient(180deg,var(--brand-bg),#ffffff 55%);
      color:var(--text);
      margin:0;
      padding:32px 16px 60px;
    }

    .wrap{max-width:1200px;margin:0 auto}
    .header{text-align:center;margin-bottom:18px}
    .nav{display:flex;gap:10px;justify-content:center;margin-top:10px}

    a.btn-nav{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      text-decoration:none;
      font-weight:600;
      font-size:13px;
    }

    .grid{
      display:grid;
      grid-template-columns:1.4fr 1fr;
      gap:20px;
      align-items:start;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.12);
    }

    h2{font-size:16px;margin:0 0 6px}
    .sub{font-size:12px;color:var(--muted);margin-bottom:10px}

    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:12px;border-bottom:1px solid var(--border);vertical-align:top}
    th{text-align:left;color:#374151;font-size:12px}

    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,monospace;font-size:11px}

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      color:#fff;
    }
    .pending{background:#3b82f6}
    .in_progress{background:#f59e0b}

    .actions{display:flex;gap:6px}
    button{
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:700;
      border:none;
      cursor:pointer;
    }
    .btn{background:var(--brand-primary);color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--border)}

    input,select,textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px;
      font-size:13px;
    }
    textarea{min-height:80px}
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <h1>Workbench</h1>
    <div class="sub">Enrichment / Validation — owner-only updates enforced by RLS</div>

    <div class="nav">
      <a class="btn-nav" href="./index.html">Upload</a>
      <a class="btn-nav" href="./admin.html">Admin Setup</a>
      <a class="btn-nav" href="./workbench.html">Workbench</a>
      <a class="btn-nav" href="#" onclick="logout()">Logout</a>
    </div>
  </div>

  <div class="grid">

    <!-- QUEUE -->
    <div class="card">
      <h2>Enrichment Queue</h2>
      <div class="sub" id="queueStatus">Loading…</div>

      <table>
        <thead>
          <tr>
            <th>Status</th>
            <th>Lead</th>
            <th>Company</th>
            <th>Owner</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>

    <!-- DETAIL -->
    <div class="card">
      <h2>Lead Detail</h2>
      <div class="sub">Select a row from the queue.</div>

      <div id="detailEmpty" class="small">No lead selected.</div>

      <div id="detailForm" style="display:none">
        <label>Phone</label>
        <input id="phoneInput"/>

        <label>Enrichment Notes</label>
        <textarea id="notesInput"></textarea>

        <label>Verified Fields (JSON)</label>
        <textarea id="verifiedInput"></textarea>

        <label>Enriched Payload (JSON)</label>
        <textarea id="payloadInput"></textarea>

        <div class="actions" style="margin-top:10px">
          <button class="btn" onclick="saveLead()">Save</button>
          <button class="btn-ghost" onclick="markDone()">Done</button>
          <button class="btn-ghost" onclick="markRejected()">Reject</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const SUPABASE_URL = "https://mwfnbmkjetriunsddupr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13Zm5ibWtqZXRyaXVuc2RkdXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzY0MDcsImV4cCI6MjA4MjA1MjQwN30._mPr3cn9Dse-oOB44AlFTDq8zjgUkIhCZG31gzeYmHU";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUserId = null;
let activeRow = null;

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function pillForStatus(s){
  return `<span class="pill ${s}">${s.replace("_"," ")}</span>`;
}

function setQueueStatus(t){document.getElementById("queueStatus").innerText=t}

async function logout(){
  await sb.auth.signOut();
  location.href="./index.html";
}

async function init(){
  const {data:{user}} = await sb.auth.getUser();
  if(!user){location.href="./index.html";return;}
  currentUserId=user.id;
  loadQueue();
}

async function loadQueue(){
  const {data:rows}=await sb.from("v_enrichment_queue").select("*");
  const body=document.getElementById("queueBody");
  body.innerHTML="";
  setQueueStatus(`Showing ${rows.length} row(s)`);

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const owner=r.enriched_by?(r.enriched_by===currentUserId?"me":"other"):"-";
    tr.innerHTML=`
      <td>${pillForStatus(r.enrichment_status)}</td>
      <td><b>${escapeHtml(r.first_name||"")} ${escapeHtml(r.last_name||"")}</b><br><span class="small">${escapeHtml(r.email||"")}</span></td>
      <td><b>${escapeHtml(r.company||"")}</b><br><span class="small">${escapeHtml(r.title||"")}</span></td>
      <td>${owner}</td>
      <td>
        <button class="btn-ghost" onclick='openRow(${JSON.stringify(r)})'>Open</button>
        ${r.enrichment_status==="pending"?`<button class="btn" onclick='claim(${JSON.stringify(r)})'>Claim</button>`:""}
      </td>`;
    body.appendChild(tr);
  });
}

async function claim(r){
  await sb.rpc("claim_lead",{p_ingest_job_id:r.ingest_job_id,p_row_number:r.row_number});
  loadQueue();
}

function openRow(r){
  activeRow=r;
  document.getElementById("detailEmpty").style.display="none";
  document.getElementById("detailForm").style.display="block";
  phoneInput.value=r.phone_enriched||"";
  notesInput.value=r.enrichment_notes||"";
  verifiedInput.value=JSON.stringify(r.verified_fields||{},null,2);
  payloadInput.value=JSON.stringify(r.enriched_payload||{},null,2);
}

async function saveLead(){
  await sb.from("stg_leads").update({
    phone_enriched:phoneInput.value,
    enrichment_notes:notesInput.value,
    verified_fields:JSON.parse(verifiedInput.value||"{}"),
    enriched_payload:JSON.parse(payloadInput.value||"{}")
  }).eq("ingest_job_id",activeRow.ingest_job_id)
    .eq("row_number",activeRow.row_number);
  loadQueue();
}

async function markDone(){
  await sb.rpc("mark_lead_done",{p_ingest_job_id:activeRow.ingest_job_id,p_row_number:activeRow.row_number});
  loadQueue();
}

async function markRejected(){
  await sb.rpc("mark_lead_rejected",{p_ingest_job_id:activeRow.ingest_job_id,p_row_number:activeRow.row_number});
  loadQueue();
}

init();
</script>
</body>
</html>
