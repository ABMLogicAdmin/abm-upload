<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABM Logic — Workbench</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --brand-primary:#30ADF7;
      --brand-navy:#22233D;
      --brand-bg:#E6F6FF;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --radius:14px;
      --shadow:0 10px 35px rgba(17,24,39,.12);
    }

    html, body { color-scheme: light; }
    *{ box-sizing:border-box; }

    body{
      font-family:Poppins,Arial,sans-serif;
      background:linear-gradient(180deg,var(--brand-bg),#ffffff 55%);
      color:var(--text);
      margin:0;
      padding:28px 16px 70px;
    }

    .wrap{
      max-width: 1600px;
     margin: 0 auto;
     padding: 0 12px;
}
    .header{ display:flex; align-items:center; gap:14px; margin-bottom:12px; }
    .logo{ height:34px; width:auto; }
    h1{ font-size:18px; margin:0; color:var(--brand-navy); font-weight:800; }
    .sub{ margin:2px 0 0; color:var(--muted); font-size:12.5px; }

    .pill{
      display:inline-block;
      font-size:11px;
      font-weight:800;
      color:var(--brand-navy);
      background:rgba(48,173,247,.18);
      border:1px solid rgba(48,173,247,.28);
      padding:4px 8px;
      border-radius:999px;
      margin-left:8px;
      vertical-align:middle;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    label{
      display:block;
      margin-top:12px;
      font-size:12.5px;
      color:var(--brand-navy);
      font-weight:700;
    }

    input,button,select,textarea{
      width:100%;
      padding:11px 12px;
      margin-top:7px;
      font-size:14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-family:inherit;
      background:#fff;
      color:var(--text);
    }
    textarea{ min-height:90px; resize:vertical; }

    .btn{
      border:none;
      background:var(--brand-primary);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      margin-top:14px;
      text-align:center;
    }
    .btn:hover{ filter:brightness(.98); }
    .btn:active{ transform:translateY(1px); }

    .btn-secondary{
      border:none;
      background:var(--brand-navy);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }

    .btn-ghost{
      background:#fff;
      color:var(--brand-navy);
      border:1px solid rgba(34,35,61,.18);
      font-weight:800;
      cursor:pointer;
    }

    .btn-danger{
      border:none;
      background:#ef4444;
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }

    .nav{
      margin-top:8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .nav a, .nav button{
      width:auto;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(34,35,61,.15);
      background:#fff;
      color:var(--brand-navy);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .nav a:hover, .nav button:hover{ filter:brightness(.98); }
    .nav .spacer{ flex:1; }

    .statusText{
      margin-top:12px;
      font-size:12.5px;
      white-space:pre-wrap;
      color:var(--brand-navy);
    }
    .muted{ color:var(--muted); font-size:12px; }
    code{ background:rgba(17,24,39,.04); padding:2px 6px; border-radius:8px; }

    /* =========================
       Layout (fixed, stable)
       ========================= */
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.2fr 1fr; /* queue left, detail wider but queue still usable */
      gap:14px;
      align-items:start;
    }

    /* CRITICAL: allow grid children to shrink so the table doesn't force page width */
    .grid > .card{ min-width:0; }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Queue controls */
    .queueHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .queueTitle{
      font-weight:900;
      color:var(--brand-navy);
      font-size:13px;
      margin:0;
    }

    /* FIX: make controls wrap nicely at any queue width */
    .queueControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:12px 0 8px;
      align-items:flex-end;
    }
    .queueControls > div{
      flex: 1 1 220px; /* will wrap when narrow */
      min-width: 200px;
    }
    .queueControls > div:last-child{
      flex: 0 0 140px; /* Clear button column */
      min-width: 120px;
    }
    @media (max-width:980px){
      .queueControls > div,
      .queueControls > div:last-child{
        flex: 1 1 100%;
        min-width: 0;
      }
    }

    .smallBtn{
      padding:10px 12px;
      margin-top:0;
      border-radius:12px;
      font-size:13px;
      font-weight:900;
    }

    /* Queue table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      padding:10px 10px;
      border-bottom:1px solid rgba(34,35,61,.12);
      white-space:nowrap;
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(34,35,61,.08);
      vertical-align:top;
      font-size:13.5px;
    }

    .leadPrimary{
      font-weight:900;
      color:var(--brand-navy);
      font-size:14px;
      line-height:1.1;
    }
    .leadSecondary{
      color:var(--muted);
      font-size:12px;
      margin-top:3px;
      line-height:1.25;
      word-break:break-word;
    }
    .companyPrimary{
      font-weight:900;
      color:var(--brand-navy);
      font-size:13.5px;
      line-height:1.1;
    }
    .companySecondary{
      color:var(--muted);
      font-size:12px;
      margin-top:3px;
      line-height:1.25;
    }

    .pillStatus{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid rgba(34,35,61,.12);
      background:#fff;
      color:var(--brand-navy);
      white-space:nowrap;
    }
    .pill-pending{
      background:rgba(48,173,247,.12);
      border-color:rgba(48,173,247,.35);
    }
    .pill-inprogress{
      background:rgba(245,158,11,.14);
      border-color:rgba(245,158,11,.35);
    }
    .pill-done{
      background:rgba(34,197,94,.14);
      border-color:rgba(34,197,94,.35);
    }
    .pill-rejected{
      background:rgba(239,68,68,.12);
      border-color:rgba(239,68,68,.35);
    }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .actions button{
      width:auto;
      padding:8px 10px;
      margin-top:0;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
    }

    /* Selected row highlight */
    tr.selected-row td{
      background: rgba(48, 173, 247, 0.12);
      border-bottom-color: rgba(48,173,247,.28);
    }
    tr.selected-row td:first-child{
      border-top-left-radius:10px;
      border-bottom-left-radius:10px;
    }
    tr.selected-row td:last-child{
      border-top-right-radius:10px;
      border-bottom-right-radius:10px;
    }

    /* Lead detail */
    .detailHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .detailTitle{
      font-weight:900;
      color:var(--brand-navy);
      font-size:13px;
      margin:0;
    }
    .detailPill{
      display:inline-block;
      font-size:11px;
      font-weight:900;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(34,35,61,.12);
      background:#fff;
      color:var(--brand-navy);
      white-space:nowrap;
    }

    .leadContext{
      padding:12px;
      margin:10px 0 12px;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:12px;
      font-size:13px;
    }
    .leadContext .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:980px){
      .leadContext .row{ grid-template-columns: 1fr; }
    }
    .ctxItem strong{ color:var(--brand-navy); font-weight:900; }
    .ctxItem span{ color:var(--text); }

    .detailGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    /* Slightly tighten lead detail typography */
.card:last-child{
  font-size:13px;
}
.card:last-child label{
  font-size:12px;
}

    @media (max-width:980px){
      .detailGrid{ grid-template-columns: 1fr; }
    }

    .footerBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .footerBtns button{
      width:auto;
      margin-top:0;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:900;
    }

    .helpLine{
      margin-top:10px;
      font-size:11.5px;
      color:var(--muted);
      line-height:1.35;
    }

    /* Login */
    .wrapSmall{ max-width:760px; margin:0 auto; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <img class="logo" src="https://abmlogic.com/abm-logic-email-logo.png" alt="ABM Logic">
      <div>
        <h1>Workbench <span class="pill">Enrichment / Validation</span></h1>
        <p class="sub">Claim → Enrich → Save → Done / Reject. Owner-only updates enforced by RLS.</p>
      </div>
    </div>

    <div class="nav" id="topNav" style="display:none;">
      <a href="./index.html">Upload</a>
      <a href="./admin.html">Admin Setup</a>
      <a href="./workbench.html" aria-current="page">Workbench</a>
      <span class="spacer"></span>
      <button id="logoutBtn">Logout</button>
    </div>

    <!-- LOGIN -->
    <div class="wrapSmall">
      <div class="card" id="loginCard">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label>Email</label>
            <input id="email" type="email" autocomplete="username" />
          </div>
          <div>
            <label>Password</label>
            <input id="password" type="password" autocomplete="current-password" />
          </div>
        </div>
        <button class="btn" id="loginBtn">Sign in</button>
        <div class="statusText" id="loginStatus"></div>
        <div class="helpLine">If login works but the queue won’t load, it’s usually RLS or missing view permissions.</div>
      </div>
    </div>

    <!-- APP -->
    <div class="grid" id="appGrid" style="display:none;">
      <!-- Queue -->
      <div class="card">
        <div class="queueHead">
          <div>
            <p class="queueTitle">Enrichment Queue</p>
            <div class="muted">Pending + in progress</div>
          </div>
          <button id="refreshBtn" class="btn-ghost smallBtn" style="width:auto;">Refresh</button>
        </div>

        <div class="queueControls">
          <div>
            <label style="margin-top:0;">View</label>
            <select id="viewSelect">
              <option value="pending_in_progress" selected>Pending + In progress</option>
              <option value="pending">Pending only</option>
              <option value="in_progress">In progress only</option>
              <option value="done">Done (read-only)</option>
              <option value="rejected">Rejected (read-only)</option>
            </select>
          </div>

          <div>
            <label style="margin-top:0;">Search</label>
            <input id="searchInput" placeholder="Search text (optional)" />
          </div>

          <div style="display:flex; align-items:end;">
            <button id="clearBtn" class="btn-ghost smallBtn" style="width:100%;">Clear</button>
          </div>
        </div>

        <div class="muted" id="queueCount">Showing 0 row(s).</div>

        <div style="overflow-x:auto; overflow-y:auto; max-width:100%; width:100%; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th style="min-width:120px;">Status</th>
                <th style="min-width:120px;">First</th>
                <th style="min-width:120px;">Last</th>
                <th style="min-width:240px;">Email</th>
                <th style="min-width:200px;">Company</th>
                <th style="min-width:220px;">Title</th>
                <th style="min-width:90px;">Owner</th>
                <th style="min-width:170px; text-align:right;">Actions</th>
              </tr>
            </thead>
            <tbody id="queueBody"></tbody>
          </table>
        </div>

        <div class="helpLine">
          Keys are <code>(ingest_job_id, row_number)</code>. That’s your primary key for stg_leads.
        </div>
      </div>

      <!-- Detail -->
      <div class="card">
        <div class="detailHead">
          <div>
            <p class="detailTitle">Lead Detail</p>
            <div class="muted">Edit enrichment fields, then Save / Done / Reject.</div>
          </div>
          <span class="detailPill" id="detailStatusPill">No lead selected</span>
        </div>

        <div class="leadContext" id="leadContext" style="display:none;">
          <div class="row">
            <div class="ctxItem"><strong>Name:</strong> <span id="ctxName"></span></div>
            <div class="ctxItem"><strong>Email:</strong> <span id="ctxEmail"></span></div>
            <div class="ctxItem"><strong>Company:</strong> <span id="ctxCompany"></span></div>
            <div class="ctxItem"><strong>Job title:</strong> <span id="ctxTitle"></span></div>
            <div class="ctxItem"><strong>Location:</strong> <span id="ctxLocation"></span></div>
            <div class="ctxItem"><strong>Owner:</strong> <span id="ctxOwner"></span></div>
          </div>
        </div>

        <div class="detailGrid">
          <div>
            <label>ingest_job_id</label>
            <input id="ingestJobId" readonly />
          </div>
          <div>
            <label>row_number</label>
            <input id="rowNumber" readonly />
          </div>
          <div>
            <label>Phone country</label>
            <select id="phoneCountry">
              <option value="" selected>Select country…</option>
              <option value="GB">United Kingdom (+44)</option>
              <option value="US">United States (+1)</option>
              <option value="CA">Canada (+1)</option>
              <option value="IE">Ireland (+353)</option>
              <option value="DE">Germany (+49)</option>
              <option value="FR">France (+33)</option>
              <option value="ES">Spain (+34)</option>
              <option value="IT">Italy (+39)</option>
              <option value="NL">Netherlands (+31)</option>
              <option value="BE">Belgium (+32)</option>
              <option value="CH">Switzerland (+41)</option>
              <option value="SE">Sweden (+46)</option>
              <option value="NO">Norway (+47)</option>
              <option value="DK">Denmark (+45)</option>
              <option value="FI">Finland (+358)</option>
              <option value="PL">Poland (+48)</option>
              <option value="AT">Austria (+43)</option>
              <option value="PT">Portugal (+351)</option>
              <option value="CZ">Czechia (+420)</option>
              <option value="HU">Hungary (+36)</option>
              <option value="RO">Romania (+40)</option>
              <option value="GR">Greece (+30)</option>
              <option value="TR">Turkey (+90)</option>

              <option value="IN">India (+91)</option>
              <option value="PK">Pakistan (+92)</option>
              <option value="BD">Bangladesh (+880)</option>
              <option value="LK">Sri Lanka (+94)</option>

              <option value="AE">United Arab Emirates (+971)</option>
              <option value="SA">Saudi Arabia (+966)</option>
              <option value="QA">Qatar (+974)</option>

              <option value="SG">Singapore (+65)</option>
              <option value="MY">Malaysia (+60)</option>
              <option value="AU">Australia (+61)</option>
              <option value="NZ">New Zealand (+64)</option>
              <option value="JP">Japan (+81)</option>
              <option value="KR">South Korea (+82)</option>

              <option value="ZA">South Africa (+27)</option>
              <option value="NG">Nigeria (+234)</option>
              <option value="KE">Kenya (+254)</option>

              <option value="BR">Brazil (+55)</option>
              <option value="MX">Mexico (+52)</option>
              <option value="AR">Argentina (+54)</option>
            </select>
          </div>

          <div>
            <label>Direct / Desk phone</label>
            <input id="phoneDirect" placeholder="+44…" />
          </div>
          <div>
            <label>Mobile phone</label>
            <input id="phoneMobile" placeholder="+44…" />
          </div>
        </div>

        <label>enrichment_notes</label>
        <textarea id="enrichmentNotes" placeholder="Add notes (why verified / changes / rejection reason etc.)"></textarea>

        <label>verified_fields (JSON)</label>
        <textarea id="verifiedFields" placeholder='{"job_title_verified":true,"company_verified":true}'></textarea>

        <label>enriched_payload (JSON)</label>
        <textarea id="enrichedPayload" placeholder='{"linkedin_url":"...","title":"..."}'></textarea>

        <label>raw_payload (read-only)</label>
        <textarea id="rawPayload" readonly placeholder="Will populate after you Open a lead…"></textarea>

        <div class="footerBtns">
          <button id="saveBtn" class="btn-secondary">Save</button>
          <button id="releaseBtn" class="btn-ghost">Release</button>
          <button id="doneBtn" class="btn">Mark Done</button>
          <button id="rejectBtn" class="btn-danger">Reject</button>
        </div>

        <div class="helpLine">
          Owner-only updates enforced by RLS. If Save fails, you likely aren’t the owner (Claim first).
        </div>

        <div class="statusText" id="detailStatus"></div>
      </div>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  // Must match your other pages
  window.ABM_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13Zm5ibWtqZXRyaXVuc2RkdXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzY0MDcsImV4cCI6MjA4MjA1MjQwN30._mPr3cn9Dse-oOB44AlFTDq8zjgUkIhCZG31gzeYmHU";
  const SUPABASE_URL = "https://mwfnbmkjetriunsddupr.supabase.co";
  // ==================

  if (!window.supabase) {
    alert("Supabase SDK failed to load (cdn.jsdelivr). Check network / extensions.");
    throw new Error("Supabase SDK not loaded");
  }

  const sb = window.supabase.createClient(SUPABASE_URL, window.ABM_SUPABASE_ANON_KEY);
  const $ = (id) => document.getElementById(id);

  // UI state
  let me = null;                 // user object
  let queueRows = [];            // loaded queue rows (from view)
  let currentLead = null;        // full row object currently opened
  let selectedLeadKey = null;    // `${ingest_job_id}:${row_number}`

  // Events
  $("loginBtn").onclick = login;
  $("logoutBtn").onclick = logout;

  $("refreshBtn").onclick = () => loadQueue(true);
  $("viewSelect").onchange = () => loadQueue();
  $("searchInput").oninput = () => renderQueue();
  $("clearBtn").onclick = () => { $("searchInput").value = ""; renderQueue(); };

  $("saveBtn").onclick = saveLead;
  $("releaseBtn").onclick = releaseLead;
  $("doneBtn").onclick = markDone;
  $("rejectBtn").onclick = markRejected;

  // Init: if already signed in, show app
  init();

  async function init(){
    const { data } = await sb.auth.getSession();
    if (data?.session?.user){
      await afterLogin();
    }
  }

  async function login(){
    $("loginStatus").textContent = "Signing in…";
    const email = $("email").value.trim();
    const password = $("password").value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error){
      $("loginStatus").textContent = error.message;
      return;
    }
    $("loginStatus").textContent = "Signed in.";
    await afterLogin();
  }

  async function afterLogin(){
    const { data: userRes, error: userErr } = await sb.auth.getUser();
    if (userErr || !userRes?.user){
      $("loginStatus").textContent = "Login succeeded but user fetch failed.";
      return;
    }
    me = userRes.user;

    $("loginCard").style.display = "none";
    $("topNav").style.display = "flex";
    $("appGrid").style.display = "grid";

    await loadQueue(true);
  }

  async function logout(){
    await sb.auth.signOut();
    location.reload();
  }

  function statusPillClass(s){
    if (s === "pending") return "pillStatus pill-pending";
    if (s === "in_progress") return "pillStatus pill-inprogress";
    if (s === "done") return "pillStatus pill-done";
    if (s === "rejected") return "pillStatus pill-rejected";
    return "pillStatus";
  }

  function ownerLabel(row){
    if (!row?.enriched_by) return "-";
    if (me && row.enriched_by === me.id) return "me";
    return "•";
  }
  
async function fetchLeadFromStg(ingestJobId, rowNumber){
  const { data, error } = await sb
    .from("stg_leads")
    .select("*")
    .eq("ingest_job_id", ingestJobId)
    .eq("row_number", rowNumber)
    .single();

  if (error) throw error;
  return data;
}
  function leadKey(row){
    return `${row.ingest_job_id}:${row.row_number}`;
  }

  async function loadQueue(forceClearDetail=false){
    $("detailStatus").textContent = "";
    const viewMode = $("viewSelect").value;

    let statuses = [];
    if (viewMode === "pending_in_progress") statuses = ["pending","in_progress"];
    else statuses = [viewMode];

    const { data, error } = await sb
      .from("v_enrichment_queue")
      .select("*")
      .in("enrichment_status", statuses)
      .order("enrichment_status", { ascending: true });

    if (error){
      $("queueCount").textContent = "Queue load failed.";
      $("detailStatus").textContent = "Error loading queue: " + error.message;
      queueRows = [];
      renderQueue();
      return;
    }

    queueRows = data || [];
    $("queueCount").textContent = `Showing ${queueRows.length} row(s).`;

    if (forceClearDetail){
      if (selectedLeadKey && !queueRows.some(r => leadKey(r) === selectedLeadKey)){
        clearDetail();
      }
    }

    renderQueue();
  }

  function renderQueue(){
    const tbody = $("queueBody");
    tbody.innerHTML = "";

    const q = ($("searchInput").value || "").toLowerCase().trim();

    const filtered = queueRows.filter(r => {
      if (!q) return true;
      const hay = [
        r.first_name, r.last_name, r.email, r.company, r.title, r.country, r.city
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });

    $("queueCount").textContent = `Showing ${filtered.length} row(s).`;

    for (const row of filtered){
      const tr = document.createElement("tr");
      const isSelected = selectedLeadKey && (leadKey(row) === selectedLeadKey);
      if (isSelected) tr.classList.add("selected-row");

      const tdStatus = document.createElement("td");
      tdStatus.innerHTML = `<span class="${statusPillClass(row.enrichment_status)}">${row.enrichment_status}</span>`;
      tr.appendChild(tdStatus);

      const tdFirst = document.createElement("td");
      tdFirst.textContent = row.first_name || "";
      tr.appendChild(tdFirst);

      const tdLast = document.createElement("td");
      tdLast.textContent = row.last_name || "";
      tr.appendChild(tdLast);

      const tdEmail = document.createElement("td");
      tdEmail.innerHTML = `<div class="leadPrimary">${escapeHtml(row.email || "")}</div>`;
      tr.appendChild(tdEmail);

      const tdCompany = document.createElement("td");
      tdCompany.innerHTML = `
        <div class="companyPrimary">${escapeHtml(row.company || "")}</div>
        <div class="companySecondary">${escapeHtml(shortKey(row.ingest_job_id, row.row_number))}</div>
      `;
      tr.appendChild(tdCompany);

      const tdTitle = document.createElement("td");
      tdTitle.textContent = row.title || "";
      tr.appendChild(tdTitle);

      const tdOwner = document.createElement("td");
      tdOwner.textContent = ownerLabel(row);
      tr.appendChild(tdOwner);

      const tdActions = document.createElement("td");
      tdActions.style.textAlign = "right";
      const actionWrap = document.createElement("div");
      actionWrap.className = "actions";

      const openBtn = document.createElement("button");
      openBtn.className = "btn-ghost";
      openBtn.textContent = "Open";
      openBtn.onclick = () => openLead(row);
      actionWrap.appendChild(openBtn);

      if (row.enrichment_status === "pending"){
        const claimBtn = document.createElement("button");
        claimBtn.className = "btn";
        claimBtn.textContent = "Claim";
        claimBtn.onclick = () => claimLead(row);
        actionWrap.appendChild(claimBtn);
      }

      tdActions.appendChild(actionWrap);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    }
  }

  function openLead(row){
    currentLead = row;
    selectedLeadKey = leadKey(row);
    renderQueue();
    renderLeadDetail();
    $("detailStatus").textContent = "";
  }

  function clearDetail(){
    currentLead = null;
    selectedLeadKey = null;
    $("leadContext").style.display = "none";
    $("detailStatusPill").textContent = "No lead selected";

    $("ingestJobId").value = "";
    $("rowNumber").value = "";
    $("phoneCountry").value = "";
    $("phoneDirect").value = "";
    $("phoneMobile").value = "";
    $("enrichmentNotes").value = "";
    $("verifiedFields").value = "";
    $("enrichedPayload").value = "";
    $("rawPayload").value = "";

    renderQueue();
  }

  function renderLeadDetail(){
    if (!currentLead) return;

    $("detailStatusPill").textContent = currentLead.enrichment_status || "—";

    $("ingestJobId").value = currentLead.ingest_job_id || "";
    $("rowNumber").value = currentLead.row_number ?? "";

    $("leadContext").style.display = "block";
    $("ctxName").textContent = `${currentLead.first_name || ""} ${currentLead.last_name || ""}`.trim();
    $("ctxEmail").textContent = currentLead.email || "";
    $("ctxCompany").textContent = currentLead.company || "";
    $("ctxTitle").textContent = currentLead.title || "";
    const loc = [currentLead.city, currentLead.state, currentLead.country].filter(Boolean).join(", ");
    $("ctxLocation").textContent = loc || "—";
    $("ctxOwner").textContent = ownerLabel(currentLead);

    $("phoneCountry").value = currentLead.phone_country_iso2 || "";
    $("phoneDirect").value = currentLead.phone_direct || "";
    $("phoneMobile").value = currentLead.phone_mobile || "";
    $("enrichmentNotes").value = currentLead.enrichment_notes || "";

    $("verifiedFields").value = stringifyJsonMaybe(currentLead.verified_fields);
    $("enrichedPayload").value = stringifyJsonMaybe(currentLead.enriched_payload);

    $("rawPayload").value = stringifyJsonMaybe(currentLead.raw_payload);

    const isReadonly = (currentLead.enrichment_status === "done" || currentLead.enrichment_status === "rejected");
    setDetailInputsDisabled(isReadonly);
  }

  function setDetailInputsDisabled(disabled){
    ["phoneCountry","phoneDirect","phoneMobile","enrichmentNotes","verifiedFields","enrichedPayload"]
      .forEach(id => $(id).disabled = disabled);

    $("saveBtn").disabled = disabled;
    $("releaseBtn").disabled = disabled;
    $("doneBtn").disabled = disabled;
    $("rejectBtn").disabled = disabled;
  }

  async function claimLead(row){
    $("detailStatus").textContent = "Claiming lead…";
    const { data, error } = await sb.rpc("claim_lead", {
      p_ingest_job_id: row.ingest_job_id,
      p_row_number: row.row_number
    });

    if (error){
      $("detailStatus").textContent = "Claim failed: " + error.message;
      return;
    }

    await loadQueue(true);
    const updated = queueRows.find(r => leadKey(r) === leadKey(row));
    if (updated) openLead(updated);

    $("detailStatus").textContent = (data === true) ? "Claimed." : "Claim returned false (already owned / not claimable).";
  }

  async function releaseLead(){
    if (!currentLead){
      $("detailStatus").textContent = "Open a lead first.";
      return;
    }
    $("detailStatus").textContent = "Releasing lead…";
    const { data, error } = await sb.rpc("release_lead", {
      p_ingest_job_id: currentLead.ingest_job_id,
      p_row_number: currentLead.row_number
    });
    if (error){
      $("detailStatus").textContent = "Release failed: " + error.message;
      return;
    }
    await loadQueue(true);
    clearDetail();
    $("detailStatus").textContent = (data === true) ? "Released." : "Release returned false.";
  }

  async function saveLead(){
    if (!currentLead){
      $("detailStatus").textContent = "Open a lead first.";
      return;
    }

    $("detailStatus").textContent = "Saving…";

    const verified = parseJsonTextarea($("verifiedFields").value);
    if (verified === "__invalid__"){
      $("detailStatus").textContent = "verified_fields JSON is invalid. Fix it and try again.";
      return;
    }

    const enriched = parseJsonTextarea($("enrichedPayload").value);
    if (enriched === "__invalid__"){
      $("detailStatus").textContent = "enriched_payload JSON is invalid. Fix it and try again.";
      return;
    }

    const update = {
      phone_country_iso2: $("phoneCountry").value || null,
      phone_direct: $("phoneDirect").value || null,
      phone_mobile: $("phoneMobile").value || null,
      enrichment_notes: ($("enrichmentNotes").value || "").trim() || null,
      verified_fields: verified === "__blank__" ? null : verified,
      enriched_payload: enriched === "__blank__" ? null : enriched
    };

    const { error } = await sb
      .from("stg_leads")
      .update(update)
      .eq("ingest_job_id", currentLead.ingest_job_id)
      .eq("row_number", currentLead.row_number);

    if (error){
      $("detailStatus").textContent = "Save failed: " + error.message;
      return;
    }

    await loadQueue(true);

    try{
      const full = await fetchLeadFromStg(currentLead.ingest_job_id, currentLead.row_number);

      // Use full stg_leads row so saved values stay visible
      currentLead = full;
      selectedLeadKey = leadKey(full);

      renderQueue();
      renderLeadDetail();

      $("detailStatus").textContent = "Saved.";
    }catch(e){
      $("detailStatus").textContent = "Saved, but failed to reload full lead: " + (e?.message || e);
    }
  }

  async function markDone(){
    if (!currentLead){
      $("detailStatus").textContent = "Open a lead first.";
      return;
    }
    $("detailStatus").textContent = "Marking done…";
    const { data, error } = await sb.rpc("mark_lead_done", {
      p_ingest_job_id: currentLead.ingest_job_id,
      p_row_number: currentLead.row_number
    });
    if (error){
      $("detailStatus").textContent = "Mark done failed: " + error.message;
      return;
    }

    const viewMode = $("viewSelect").value;
    await loadQueue(true);

    if (viewMode !== "done"){
      clearDetail();
    } else {
      const updated = queueRows.find(r => leadKey(r) === selectedLeadKey);
      if (updated) openLead(updated);
    }

    $("detailStatus").textContent = (data === true) ? "Marked done." : "Mark done returned false.";
  }

  async function markRejected(){
    if (!currentLead){
      $("detailStatus").textContent = "Open a lead first.";
      return;
    }
    $("detailStatus").textContent = "Marking rejected…";
    const { data, error } = await sb.rpc("mark_lead_rejected", {
      p_ingest_job_id: currentLead.ingest_job_id,
      p_row_number: currentLead.row_number
    });
    if (error){
      $("detailStatus").textContent = "Reject failed: " + error.message;
      return;
    }

    const viewMode = $("viewSelect").value;
    await loadQueue(true);

    if (viewMode !== "rejected"){
      clearDetail();
    } else {
      const updated = queueRows.find(r => leadKey(r) === selectedLeadKey);
      if (updated) openLead(updated);
    }

    $("detailStatus").textContent = (data === true) ? "Rejected." : "Reject returned false.";
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function shortKey(ingest_job_id, row_number){
    if (!ingest_job_id) return "";
    const s = String(ingest_job_id);
    return `${s.slice(0,8)}… • row ${row_number}`;
  }

  function stringifyJsonMaybe(val){
    if (val === null || val === undefined) return "";
    try{
      if (typeof val === "string"){
        const trimmed = val.trim();
        if (!trimmed) return "";
        const parsed = JSON.parse(trimmed);
        return JSON.stringify(parsed, null, 2);
      }
      return JSON.stringify(val, null, 2);
    }catch{
      return String(val);
    }
  }

  function parseJsonTextarea(text){
    const t = (text || "").trim();
    if (!t) return "__blank__";
    try{
      return JSON.parse(t);
    }catch{
      return "__invalid__";
    }
  }
</script>
</body>
</html>
