<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABM Logic — Workbench</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --brand-primary:#30ADF7;
      --brand-navy:#22233D;
      --brand-bg:#E6F6FF;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --radius:14px;
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;
    }
    html, body { color-scheme: light; }
    select, option { background-color:#ffffff !important; color:#111827 !important; }

    *{box-sizing:border-box}
    body{
      font-family:Poppins,Arial,sans-serif;
      background:linear-gradient(180deg,var(--brand-bg),#ffffff 55%);
      color:var(--text);
      margin:0;
      padding:32px 16px 60px;
    }

    .wrap{max-width:1360px;margin:0 auto}

    .header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
    .logo{height:34px;width:auto}
    h1{font-size:18px;margin:0;color:var(--brand-navy);font-weight:700}
    .sub{margin:2px 0 0;color:var(--muted);font-size:12.5px}

    .card{
      margin-top:18px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 8px 30px rgba(17,24,39,.06);
    }

    label{display:block;margin-top:14px;font-size:12.5px;color:var(--brand-navy);font-weight:600}

    input,button,select,textarea{
      width:100%;
      padding:11px 12px;
      margin-top:7px;
      font-size:14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-family:inherit;
      background:#fff;
      color:var(--text);
    }
    textarea{min-height:120px; resize:vertical;}

    .btn{
      border:none;
      background:var(--brand-primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      margin-top:14px;
      text-align:center;
    }
    .btn:hover{filter:brightness(.98)}
    .btn:active{transform:translateY(1px)}

    .btn-ghost{
      border:1px solid rgba(34,35,61,.15);
      background:#fff;
      color:var(--brand-navy);
      font-weight:800;
      cursor:pointer;
      margin-top:14px;
    }

    .btn-navy{
      border:none;
      background:var(--brand-navy);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      margin-top:14px;
    }

    .btn-danger{
      border:none;
      background:var(--bad);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      margin-top:14px;
    }

    .status{margin-top:14px;font-size:12.5px;white-space:pre-wrap}
    .hint{ font-size:12px;color:var(--muted);margin-top:10px; }

    .pill{
      display:inline-block;
      font-size:11px;
      font-weight:800;
      color:var(--brand-navy);
      background:rgba(48,173,247,.18);
      border:1px solid rgba(48,173,247,.28);
      padding:4px 8px;
      border-radius:999px;
      margin-left:8px;
      vertical-align:middle;
    }
    .pill-ok{background:rgba(22,163,74,.14);border-color:rgba(22,163,74,.25)}
    .pill-warn{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.25)}
    .pill-bad{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.25)}

    .nav{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
      align-items:center;
    }
    .nav a, .nav button{
      width:auto;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(34,35,61,.15);
      background:#fff;
      color:var(--brand-navy);
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:0;
    }
    .spacer{flex:1}

    /* Queue wider */
    .grid{
      display:grid;
      grid-template-columns: 1.75fr 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }

    .queueTable{
      font-size:13.8px;
    }
    .queueTable thead th{
      text-align:left;
      font-size:12.8px;
      color:var(--muted);
      padding:12px 10px;
      border-bottom:1px solid rgba(34,35,61,.10);
      white-space:nowrap;
    }
    .queueTable tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(34,35,61,.08);
      vertical-align:top;
    }
    .queueTable tbody tr:hover{background:rgba(48,173,247,.06);}

    .small{font-size:12.5px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .actions button{
      width:auto;
      margin-top:0;
      padding:8px 10px;
      font-size:12px;
      border-radius:999px;
      white-space:nowrap;
    }

    .detailHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:4px;
    }
    .detailKey{
      font-weight:800;
      color:var(--brand-navy);
      font-size:13px;
    }
    .divider{
      margin:14px 0;
      border:none;
      border-top:1px solid rgba(34,35,61,.12);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width: 640px){
      .row, .row3{grid-template-columns:1fr;}
    }

    .keyTiny{font-size:11px;color:var(--muted)}
    .tightLabel{margin-top:10px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <img class="logo" src="https://abmlogic.com/abm-logic-email-logo.png" alt="ABM Logic">
      <div style="flex:1;">
        <h1>Workbench <span class="pill">Enrichment / Validation</span></h1>
        <p class="sub">Claim → Enrich → Done / Reject. Owner-only updates enforced by RLS.</p>

        <div class="nav">
          <a href="./index.html">Upload</a>
          <a id="adminLink" href="./admin.html" style="display:none;">Admin Setup</a>
          <a href="./workbench.html">Workbench</a>
          <span class="spacer"></span>
          <button id="logoutBtn" type="button" style="display:none;">Logout</button>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginCard">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" autocomplete="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" />
        </div>
      </div>
      <button class="btn" id="loginBtn">Sign in</button>
      <div class="status" id="loginStatus"></div>
      <div class="hint">If you can’t see any leads, check stg_leads has rows and RLS allows SELECT for authenticated.</div>
    </div>

    <!-- APP -->
    <div id="appWrap" style="display:none;">
      <div class="grid">

        <!-- LEFT: Queue -->
        <div class="card">
          <div class="detailHead">
            <div>
              <div class="detailKey">Enrichment Queue</div>
              <div class="small">Pending + in progress</div>
            </div>
            <button id="refreshBtn" class="btn-ghost" type="button" style="width:auto;margin-top:0;">Refresh</button>
          </div>

          <div class="row3" style="margin-top:10px;">
            <div>
              <label>View</label>
              <select id="viewFilter">
                <option value="pending">Pending</option>
                <option value="mine">In progress (mine)</option>
                <option value="all" selected>Pending + In progress</option>
              </select>
            </div>
            <div>
              <label>Search</label>
              <input id="searchBox" placeholder="Search text (optional)" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="clearBtn" class="btn-ghost" type="button" style="margin-top:7px;">Clear</button>
            </div>
          </div>

          <div class="status" id="queueStatus"></div>

          <div style="overflow:auto; margin-top:10px;">
            <table class="queueTable">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>First</th>
                  <th>Last</th>
                  <th>Email</th>
                  <th>Company</th>
                  <th>Title</th>
                  <th>Owner</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="queueBody"></tbody>
            </table>
          </div>

          <div class="hint">
            Key is <span class="mono">(ingest_job_id, row_number)</span>. That’s your primary key for stg_leads.
          </div>
        </div>

        <!-- RIGHT: Detail -->
        <div class="card">
          <div class="detailHead">
            <div>
              <div class="detailKey">Lead Detail</div>
              <div class="small" id="detailSub">Select a row from the queue.</div>
            </div>
            <div id="detailPill"></div>
          </div>

          <hr class="divider" />

          <div id="detailEmpty" class="small" style="color:var(--muted);">
            No lead selected.
          </div>

          <div id="detailForm" style="display:none;">
            <div class="row">
              <div>
                <label>ingest_job_id</label>
                <input id="d_ingest_job_id" class="mono" disabled />
              </div>
              <div>
                <label>row_number</label>
                <input id="d_row_number" class="mono" disabled />
              </div>
            </div>

            <!-- NEW: Phone fields -->
            <div class="row3">
              <div>
                <label class="tightLabel">Phone country</label>
                <select id="d_phone_country">
                  <option value="">Select country…</option>
                </select>
                <div class="small" id="dialHint" style="margin-top:6px;"></div>
              </div>
              <div>
                <label class="tightLabel">Direct / Desk phone</label>
                <input id="d_phone_direct" placeholder="+44…" />
              </div>
              <div>
                <label class="tightLabel">Mobile phone</label>
                <input id="d_phone_mobile" placeholder="+44…" />
              </div>
            </div>

            <label>enrichment_notes</label>
            <textarea id="d_notes" placeholder="Add notes (why verified / changes / rejection reason etc.)"></textarea>

            <label>verified_fields (JSON)</label>
            <textarea id="d_verified" placeholder='{"job_title_verified":true,"company_verified":true}'></textarea>

            <label>enriched_payload (JSON)</label>
            <textarea id="d_payload" placeholder='{"linkedin_url":"...","title":"..."}'></textarea>

            <div class="actions" style="margin-top:12px;">
              <button id="saveBtn" class="btn-navy" type="button">Save</button>
              <button id="releaseBtn" class="btn-ghost" type="button">Release</button>
              <button id="doneBtn" class="btn" type="button">Mark Done</button>
              <button id="rejectBtn" class="btn-danger" type="button">Reject</button>
            </div>

            <div class="status" id="detailStatus"></div>
            <div class="hint">Owner-only updates enforced by RLS. If Save fails, you likely aren’t the owner.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  const SUPABASE_URL = "https://mwfnbmkjetriunsddupr.supabase.co";
  window.ABM_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13Zm5ibWtqZXRyaXVuc2RkdXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzY0MDcsImV4cCI6MjA4MjA1MjQwN30._mPr3cn9Dse-oOB44AlFTDq8zjgUkIhCZG31gzeYmHU";
  // ==================

  const sb = window.supabase.createClient(SUPABASE_URL, window.ABM_SUPABASE_ANON_KEY);
  const $ = (id) => document.getElementById(id);

  let currentUserId = null;
  let selected = null;

  // ISO2 -> dial code (coverage is broad; some territories share codes)
  const DIAL = {
    "AF":"+93","AL":"+355","DZ":"+213","AS":"+1","AD":"+376","AO":"+244","AI":"+1","AQ":"+672","AG":"+1","AR":"+54","AM":"+374","AW":"+297",
    "AU":"+61","AT":"+43","AZ":"+994","BS":"+1","BH":"+973","BD":"+880","BB":"+1","BY":"+375","BE":"+32","BZ":"+501","BJ":"+229","BM":"+1",
    "BT":"+975","BO":"+591","BQ":"+599","BA":"+387","BW":"+267","BR":"+55","IO":"+246","BN":"+673","BG":"+359","BF":"+226","BI":"+257","KH":"+855",
    "CM":"+237","CA":"+1","CV":"+238","KY":"+1","CF":"+236","TD":"+235","CL":"+56","CN":"+86","CX":"+61","CC":"+61","CO":"+57","KM":"+269","CG":"+242",
    "CD":"+243","CK":"+682","CR":"+506","CI":"+225","HR":"+385","CU":"+53","CW":"+599","CY":"+357","CZ":"+420","DK":"+45","DJ":"+253","DM":"+1","DO":"+1",
    "EC":"+593","EG":"+20","SV":"+503","GQ":"+240","ER":"+291","EE":"+372","SZ":"+268","ET":"+251","FK":"+500","FO":"+298","FJ":"+679","FI":"+358","FR":"+33",
    "GF":"+594","PF":"+689","GA":"+241","GM":"+220","GE":"+995","DE":"+49","GH":"+233","GI":"+350","GR":"+30","GL":"+299","GD":"+1","GP":"+590","GU":"+1",
    "GT":"+502","GG":"+44","GN":"+224","GW":"+245","GY":"+592","HT":"+509","HN":"+504","HK":"+852","HU":"+36","IS":"+354","IN":"+91","ID":"+62","IR":"+98","IQ":"+964",
    "IE":"+353","IM":"+44","IL":"+972","IT":"+39","JM":"+1","JP":"+81","JE":"+44","JO":"+962","KZ":"+7","KE":"+254","KI":"+686","KP":"+850","KR":"+82","KW":"+965",
    "KG":"+996","LA":"+856","LV":"+371","LB":"+961","LS":"+266","LR":"+231","LY":"+218","LI":"+423","LT":"+370","LU":"+352","MO":"+853","MG":"+261","MW":"+265",
    "MY":"+60","MV":"+960","ML":"+223","MT":"+356","MH":"+692","MQ":"+596","MR":"+222","MU":"+230","YT":"+262","MX":"+52","FM":"+691","MD":"+373","MC":"+377",
    "MN":"+976","ME":"+382","MS":"+1","MA":"+212","MZ":"+258","MM":"+95","NA":"+264","NR":"+674","NP":"+977","NL":"+31","NC":"+687","NZ":"+64","NI":"+505",
    "NE":"+227","NG":"+234","NU":"+683","NF":"+672","MK":"+389","MP":"+1","NO":"+47","OM":"+968","PK":"+92","PW":"+680","PS":"+970","PA":"+507","PG":"+675",
    "PY":"+595","PE":"+51","PH":"+63","PL":"+48","PT":"+351","PR":"+1","QA":"+974","RE":"+262","RO":"+40","RU":"+7","RW":"+250","BL":"+590","SH":"+290","KN":"+1",
    "LC":"+1","MF":"+590","PM":"+508","VC":"+1","WS":"+685","SM":"+378","ST":"+239","SA":"+966","SN":"+221","RS":"+381","SC":"+248","SL":"+232","SG":"+65",
    "SX":"+1","SK":"+421","SI":"+386","SB":"+677","SO":"+252","ZA":"+27","SS":"+211","ES":"+34","LK":"+94","SD":"+249","SR":"+597","SE":"+46","CH":"+41","SY":"+963",
    "TW":"+886","TJ":"+992","TZ":"+255","TH":"+66","TL":"+670","TG":"+228","TK":"+690","TO":"+676","TT":"+1","TN":"+216","TR":"+90","TM":"+993","TC":"+1","TV":"+688",
    "UG":"+256","UA":"+380","AE":"+971","GB":"+44","US":"+1","UY":"+598","UZ":"+998","VU":"+678","VA":"+379","VE":"+58","VN":"+84","VG":"+1","VI":"+1","YE":"+967",
    "ZM":"+260","ZW":"+263"
  };

  // Full list (ISO2 + name) - used to populate the dropdown
  const COUNTRIES = [
    ["AF","Afghanistan"],["AL","Albania"],["DZ","Algeria"],["AS","American Samoa"],["AD","Andorra"],["AO","Angola"],["AI","Anguilla"],["AQ","Antarctica"],
    ["AG","Antigua and Barbuda"],["AR","Argentina"],["AM","Armenia"],["AW","Aruba"],["AU","Australia"],["AT","Austria"],["AZ","Azerbaijan"],["BS","Bahamas"],
    ["BH","Bahrain"],["BD","Bangladesh"],["BB","Barbados"],["BY","Belarus"],["BE","Belgium"],["BZ","Belize"],["BJ","Benin"],["BM","Bermuda"],["BT","Bhutan"],
    ["BO","Bolivia"],["BQ","Bonaire, Sint Eustatius and Saba"],["BA","Bosnia and Herzegovina"],["BW","Botswana"],["BR","Brazil"],["IO","British Indian Ocean Territory"],
    ["BN","Brunei"],["BG","Bulgaria"],["BF","Burkina Faso"],["BI","Burundi"],["KH","Cambodia"],["CM","Cameroon"],["CA","Canada"],["CV","Cape Verde"],
    ["KY","Cayman Islands"],["CF","Central African Republic"],["TD","Chad"],["CL","Chile"],["CN","China"],["CX","Christmas Island"],["CC","Cocos (Keeling) Islands"],
    ["CO","Colombia"],["KM","Comoros"],["CG","Congo"],["CD","Congo (DRC)"],["CK","Cook Islands"],["CR","Costa Rica"],["CI","Côte d’Ivoire"],["HR","Croatia"],
    ["CU","Cuba"],["CW","Curaçao"],["CY","Cyprus"],["CZ","Czechia"],["DK","Denmark"],["DJ","Djibouti"],["DM","Dominica"],["DO","Dominican Republic"],
    ["EC","Ecuador"],["EG","Egypt"],["SV","El Salvador"],["GQ","Equatorial Guinea"],["ER","Eritrea"],["EE","Estonia"],["SZ","Eswatini"],["ET","Ethiopia"],
    ["FK","Falkland Islands"],["FO","Faroe Islands"],["FJ","Fiji"],["FI","Finland"],["FR","France"],["GF","French Guiana"],["PF","French Polynesia"],
    ["GA","Gabon"],["GM","Gambia"],["GE","Georgia"],["DE","Germany"],["GH","Ghana"],["GI","Gibraltar"],["GR","Greece"],["GL","Greenland"],["GD","Grenada"],
    ["GP","Guadeloupe"],["GU","Guam"],["GT","Guatemala"],["GG","Guernsey"],["GN","Guinea"],["GW","Guinea-Bissau"],["GY","Guyana"],["HT","Haiti"],
    ["HN","Honduras"],["HK","Hong Kong"],["HU","Hungary"],["IS","Iceland"],["IN","India"],["ID","Indonesia"],["IR","Iran"],["IQ","Iraq"],["IE","Ireland"],
    ["IM","Isle of Man"],["IL","Israel"],["IT","Italy"],["JM","Jamaica"],["JP","Japan"],["JE","Jersey"],["JO","Jordan"],["KZ","Kazakhstan"],["KE","Kenya"],
    ["KI","Kiribati"],["KP","Korea (North)"],["KR","Korea (South)"],["KW","Kuwait"],["KG","Kyrgyzstan"],["LA","Laos"],["LV","Latvia"],["LB","Lebanon"],
    ["LS","Lesotho"],["LR","Liberia"],["LY","Libya"],["LI","Liechtenstein"],["LT","Lithuania"],["LU","Luxembourg"],["MO","Macao"],["MG","Madagascar"],
    ["MW","Malawi"],["MY","Malaysia"],["MV","Maldives"],["ML","Mali"],["MT","Malta"],["MH","Marshall Islands"],["MQ","Martinique"],["MR","Mauritania"],
    ["MU","Mauritius"],["YT","Mayotte"],["MX","Mexico"],["FM","Micronesia"],["MD","Moldova"],["MC","Monaco"],["MN","Mongolia"],["ME","Montenegro"],
    ["MS","Montserrat"],["MA","Morocco"],["MZ","Mozambique"],["MM","Myanmar"],["NA","Namibia"],["NR","Nauru"],["NP","Nepal"],["NL","Netherlands"],
    ["NC","New Caledonia"],["NZ","New Zealand"],["NI","Nicaragua"],["NE","Niger"],["NG","Nigeria"],["NU","Niue"],["NF","Norfolk Island"],["MK","North Macedonia"],
    ["MP","Northern Mariana Islands"],["NO","Norway"],["OM","Oman"],["PK","Pakistan"],["PW","Palau"],["PS","Palestine"],["PA","Panama"],["PG","Papua New Guinea"],
    ["PY","Paraguay"],["PE","Peru"],["PH","Philippines"],["PL","Poland"],["PT","Portugal"],["PR","Puerto Rico"],["QA","Qatar"],["RE","Réunion"],["RO","Romania"],
    ["RU","Russia"],["RW","Rwanda"],["BL","Saint Barthélemy"],["SH","Saint Helena"],["KN","Saint Kitts and Nevis"],["LC","Saint Lucia"],["MF","Saint Martin"],
    ["PM","Saint Pierre and Miquelon"],["VC","Saint Vincent and the Grenadines"],["WS","Samoa"],["SM","San Marino"],["ST","São Tomé and Príncipe"],
    ["SA","Saudi Arabia"],["SN","Senegal"],["RS","Serbia"],["SC","Seychelles"],["SL","Sierra Leone"],["SG","Singapore"],["SX","Sint Maarten"],["SK","Slovakia"],
    ["SI","Slovenia"],["SB","Solomon Islands"],["SO","Somalia"],["ZA","South Africa"],["SS","South Sudan"],["ES","Spain"],["LK","Sri Lanka"],["SD","Sudan"],
    ["SR","Suriname"],["SE","Sweden"],["CH","Switzerland"],["SY","Syria"],["TW","Taiwan"],["TJ","Tajikistan"],["TZ","Tanzania"],["TH","Thailand"],
    ["TL","Timor-Leste"],["TG","Togo"],["TK","Tokelau"],["TO","Tonga"],["TT","Trinidad and Tobago"],["TN","Tunisia"],["TR","Turkey"],["TM","Turkmenistan"],
    ["TC","Turks and Caicos Islands"],["TV","Tuvalu"],["UG","Uganda"],["UA","Ukraine"],["AE","United Arab Emirates"],["GB","United Kingdom"],["US","United States"],
    ["UY","Uruguay"],["UZ","Uzbekistan"],["VU","Vanuatu"],["VA","Vatican City"],["VE","Venezuela"],["VN","Vietnam"],["VG","Virgin Islands (British)"],
    ["VI","Virgin Islands (US)"],["YE","Yemen"],["ZM","Zambia"],["ZW","Zimbabwe"]
  ];

  function populateCountryDropdown() {
    const sel = $("d_phone_country");
    // already populated?
    if (sel.options.length > 1) return;

    for (const [iso, name] of COUNTRIES) {
      const opt = document.createElement("option");
      opt.value = iso;
      const dial = DIAL[iso] ? ` (${DIAL[iso]})` : "";
      opt.textContent = `${name} — ${iso}${dial}`;
      sel.appendChild(opt);
    }
  }

  function updateDialHint() {
    const iso = $("d_phone_country").value;
    const dial = DIAL[iso] || "";
    $("dialHint").textContent = dial ? `Dial code: ${dial}` : "";
  }

  function maybePrefillDialCode() {
    const iso = $("d_phone_country").value;
    const dial = DIAL[iso] || "";
    if (!dial) return;

    const direct = $("d_phone_direct").value.trim();
    const mobile = $("d_phone_mobile").value.trim();

    // only prefill if empty
    if (!direct) $("d_phone_direct").value = dial;
    if (!mobile) $("d_phone_mobile").value = dial;
  }

  $("d_phone_country")?.addEventListener("change", () => {
    updateDialHint();
    maybePrefillDialCode();
  });

  $("loginBtn").onclick = login;
  $("logoutBtn").onclick = logout;

  $("refreshBtn").onclick = loadQueue;
  $("viewFilter").onchange = loadQueue;
  $("searchBox").oninput = debounce(loadQueue, 300);
  $("clearBtn").onclick = () => { $("searchBox").value = ""; loadQueue(); };

  $("saveBtn").onclick = saveSelected;
  $("releaseBtn").onclick = releaseSelected;
  $("doneBtn").onclick = doneSelected;
  $("rejectBtn").onclick = rejectSelected;

  async function logout() {
    await sb.auth.signOut();
    location.reload();
  }

  async function isAdmin() {
    const { data: userRes, error: userErr } = await sb.auth.getUser();
    if (userErr || !userRes?.user) return false;

    const { data, error } = await sb
      .from("app_users")
      .select("role")
      .eq("user_id", userRes.user.id)
      .single();

    if (error) return false;
    return data?.role === "admin";
  }

  function pillForStatus(status) {
    if (status === "done") return `<span class="pill pill-ok">done</span>`;
    if (status === "rejected") return `<span class="pill pill-bad">rejected</span>`;
    if (status === "in_progress") return `<span class="pill pill-warn">in_progress</span>`;
    return `<span class="pill">pending</span>`;
  }

  function setQueueStatus(msg) { $("queueStatus").textContent = msg || ""; }
  function setDetailStatus(msg) { $("detailStatus").textContent = msg || ""; }

  async function login() {
    $("loginStatus").textContent = "Signing in…";
    const { error } = await sb.auth.signInWithPassword({
      email: $("email").value.trim(),
      password: $("password").value
    });
    if (error) {
      $("loginStatus").textContent = error.message;
      return;
    }
    $("loginStatus").textContent = "";
    await showApp();
  }

  async function showApp() {
    populateCountryDropdown();

    const { data: userRes } = await sb.auth.getUser();
    currentUserId = userRes?.user?.id || null;

    $("loginCard").style.display = "none";
    $("appWrap").style.display = "block";
    $("logoutBtn").style.display = "inline-flex";

    const admin = await isAdmin();
    if (admin) $("adminLink").style.display = "inline-flex";

    await loadQueue();
  }

  function matchesSearch(row, q) {
    if (!q) return true;
    const hay = [
      row.first_name || "",
      row.last_name || "",
      row.email || "",
      row.company || "",
      row.title || "",
      row.ingest_job_id || "",
      String(row.row_number || ""),
      row.enrichment_status || ""
    ].join(" ").toLowerCase();
    return hay.includes(q);
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadQueue() {
    setQueueStatus("Loading queue…");
    const view = $("viewFilter").value;
    const q = $("searchBox").value.trim().toLowerCase();

    const { data: rows, error } = await sb
      .from("v_enrichment_queue")
      .select("*")
      .limit(500);

    if (error) {
      setQueueStatus("❌ Failed to load queue: " + error.message);
      return;
    }

    let filtered = rows || [];

    if (view === "pending") {
      filtered = filtered.filter(r => r.enrichment_status === "pending");
    } else if (view === "mine") {
      filtered = filtered.filter(r => r.enrichment_status === "in_progress" && r.enriched_by === currentUserId);
    }

    filtered = filtered.filter(r => matchesSearch(r, q));

    const body = $("queueBody");
    body.innerHTML = "";

    if (!filtered.length) {
      setQueueStatus("No rows.");
      return;
    }

    setQueueStatus(`Showing ${filtered.length} row(s).`);

    for (const r of filtered) {
      const tr = document.createElement("tr");

      const owner = r.enriched_by ? (r.enriched_by === currentUserId ? "me" : "other") : "-";
      const canOpen = (r.enrichment_status === "pending") || (r.enrichment_status === "in_progress" && r.enriched_by === currentUserId);

      tr.innerHTML = `
        <td>${pillForStatus(r.enrichment_status)}</td>
        <td>${escapeHtml(r.first_name || "")}</td>
        <td>${escapeHtml(r.last_name || "")}</td>
        <td>${escapeHtml(r.email || "")}</td>
        <td>
          <div style="font-weight:800;color:var(--brand-navy);">${escapeHtml(r.company || "")}</div>
          <div class="keyTiny mono">${escapeHtml(String(r.ingest_job_id).slice(0,8))}… • row ${escapeHtml(String(r.row_number))}</div>
        </td>
        <td>${escapeHtml(r.title || "")}</td>
        <td>${escapeHtml(owner)}</td>
        <td>
          <div class="actions">
            <button class="btn-ghost" type="button" ${canOpen ? "" : "disabled"}>Open</button>
            ${r.enrichment_status === "pending" ? `<button class="btn" type="button">Claim</button>` : ``}
          </div>
        </td>
      `;

      const buttons = tr.querySelectorAll("button");
      const openBtn = buttons[0];
      openBtn.onclick = () => openRow(r);

      if (r.enrichment_status === "pending") {
        const claimBtn = buttons[1];
        claimBtn.onclick = async () => {
          await claimThenOpen(r);
        };
      }

      body.appendChild(tr);
    }
  }

  async function claimThenOpen(row) {
    setQueueStatus("Claiming lead…");
    const { data, error } = await sb.rpc("claim_lead", {
      p_ingest_job_id: row.ingest_job_id,
      p_row_number: row.row_number
    });

    if (error) {
      setQueueStatus("❌ claim_lead error: " + error.message);
      return;
    }

    if (!data) {
      setQueueStatus("⚠️ Already claimed by someone else.");
      await loadQueue();
      return;
    }

    setQueueStatus("✅ Claimed.");
    await loadQueue();
    await openRow({ ...row, enrichment_status: "in_progress", enriched_by: currentUserId });
  }

  async function openRow(row) {
    if (row.enrichment_status === "pending") {
      await claimThenOpen(row);
      return;
    }

    if (row.enrichment_status === "in_progress" && row.enriched_by !== currentUserId) {
      setQueueStatus("⚠️ This lead is in progress by someone else.");
      return;
    }

    selected = { ingest_job_id: row.ingest_job_id, row_number: row.row_number };

    $("detailEmpty").style.display = "none";
    $("detailForm").style.display = "block";

    $("d_ingest_job_id").value = row.ingest_job_id;
    $("d_row_number").value = row.row_number;
    $("detailSub").textContent = "Edit enrichment fields, then Save / Done / Reject.";
    $("detailPill").innerHTML = pillForStatus(row.enrichment_status);
    setDetailStatus("Loading lead…");

    const { data: lead, error } = await sb
      .from("stg_leads")
      .select("ingest_job_id,row_number,enrichment_status,enriched_by,enriched_at,phone_country_iso2,phone_direct,phone_mobile,enrichment_notes,verified_fields,enriched_payload")
      .eq("ingest_job_id", row.ingest_job_id)
      .eq("row_number", row.row_number)
      .single();

    if (error) {
      setDetailStatus("❌ Failed to load lead: " + error.message);
      return;
    }

    // phone fields
    $("d_phone_country").value = lead.phone_country_iso2 || "";
    updateDialHint();
    $("d_phone_direct").value = lead.phone_direct || "";
    $("d_phone_mobile").value = lead.phone_mobile || "";

    $("d_notes").value = lead.enrichment_notes || "";
    $("d_verified").value = lead.verified_fields ? JSON.stringify(lead.verified_fields, null, 2) : "";
    $("d_payload").value = lead.enriched_payload ? JSON.stringify(lead.enriched_payload, null, 2) : "";

    $("detailPill").innerHTML = pillForStatus(lead.enrichment_status);
    setDetailStatus("");
  }

  function parseJsonOrNull(text, labelForError) {
    const t = (text || "").trim();
    if (!t) return null;
    try {
      return JSON.parse(t);
    } catch (e) {
      throw new Error(`${labelForError} must be valid JSON.`);
    }
  }

  async function saveSelected() {
    if (!selected) return;

    setDetailStatus("Saving…");

    let verified = null;
    let payload = null;
    try {
      verified = parseJsonOrNull($("d_verified").value, "verified_fields");
      payload = parseJsonOrNull($("d_payload").value, "enriched_payload");
    } catch (e) {
      setDetailStatus("❌ " + e.message);
      return;
    }

    const updates = {
      phone_country_iso2: $("d_phone_country").value || null,
      phone_direct: $("d_phone_direct").value.trim() || null,
      phone_mobile: $("d_phone_mobile").value.trim() || null,
      enrichment_notes: $("d_notes").value.trim() || null,
      verified_fields: verified,
      enriched_payload: payload
    };

    const { error } = await sb
      .from("stg_leads")
      .update(updates)
      .eq("ingest_job_id", selected.ingest_job_id)
      .eq("row_number", selected.row_number);

    if (error) {
      setDetailStatus("❌ Save failed: " + error.message);
      return;
    }

    setDetailStatus("✅ Saved.");
    await loadQueue();
  }

  async function releaseSelected() {
    if (!selected) return;
    setDetailStatus("Releasing…");

    const { data, error } = await sb.rpc("release_lead", {
      p_ingest_job_id: selected.ingest_job_id,
      p_row_number: selected.row_number
    });

    if (error) {
      setDetailStatus("❌ release_lead error: " + error.message);
      return;
    }

    if (!data) {
      setDetailStatus("⚠️ Not released (maybe not yours or not in_progress).");
      await loadQueue();
      return;
    }

    setDetailStatus("✅ Released back to pending.");
    selected = null;
    $("detailForm").style.display = "none";
    $("detailEmpty").style.display = "block";
    $("detailSub").textContent = "Select a row from the queue.";
    $("detailPill").innerHTML = "";
    await loadQueue();
  }

  async function doneSelected() {
    if (!selected) return;
    setDetailStatus("Marking done…");

    const { data, error } = await sb.rpc("mark_lead_done", {
      p_ingest_job_id: selected.ingest_job_id,
      p_row_number: selected.row_number
    });

    if (error) {
      setDetailStatus("❌ mark_lead_done error: " + error.message);
      return;
    }

    if (!data) {
      setDetailStatus("⚠️ Not marked done (maybe not yours or not in_progress).");
      return;
    }

    setDetailStatus("✅ Marked done.");
    await loadQueue();
  }

  async function rejectSelected() {
    if (!selected) return;

    const reason = prompt("Reject reason (required):");
    if (!reason || !reason.trim()) {
      setDetailStatus("⚠️ Reject cancelled (reason required).");
      return;
    }

    setDetailStatus("Rejecting…");

    const { data, error } = await sb.rpc("mark_lead_rejected", {
      p_ingest_job_id: selected.ingest_job_id,
      p_row_number: selected.row_number,
      p_reason: reason.trim()
    });

    if (error) {
      setDetailStatus("❌ mark_lead_rejected error: " + error.message);
      return;
    }

    if (!data) {
      setDetailStatus("⚠️ Not rejected (maybe not yours or not in_progress).");
      return;
    }

    $("d_notes").value = reason.trim();
    setDetailStatus("✅ Rejected.");
    await loadQueue();
  }

  sb.auth.getSession()
    .then(async (r) => {
      if (r.data.session) await showApp();
    })
    .catch(()=>{});

  function debounce(fn, ms){
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }
</script>

</body>
</html>
