<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ABM Logic â€” CSV Upload</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/abm-upload/base.css?v=12">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --brand-primary:#30ADF7;
      --brand-navy:#22233D;
      --brand-bg:#E6F6FF;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#ffffff;
      --radius:14px;
    }
    html, body { color-scheme: light; }
    select, option { background-color:#ffffff !important; color:#111827 !important; }

    *{box-sizing:border-box}
    body{
      font-family:Poppins,Arial,sans-serif;
      background:linear-gradient(180deg,var(--brand-bg),#ffffff 55%);
      color:var(--text);
      margin:0;
      padding:32px 16px 60px;
    }
    .wrap{max-width:760px;margin:0 auto}
  

    .card{
      margin-top:18px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 8px 30px rgba(17,24,39,06);
    }
    label{display:block;margin-top:14px;font-size:12.5px;color:var(--brand-navy);font-weight:600}

    input,button,select{
      width:100%;
      padding:11px 12px;
      margin-top:7px;
      font-size:14px;
      border-radius:10px;
      border:1px solid var(--border);
      font-family:inherit;
      background:#fff;
      color:var(--text);
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{
      border:none;
      background:var(--brand-primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      margin-top:18px;
      text-align:center;
    }
    .btn:hover{filter:brightness(.98)}
    .btn:active{transform:translateY(1px)}
    .status{margin-top:14px;font-size:12.5px;white-space:pre-wrap}
    
    @media (max-width:640px){.row{grid-template-columns:1fr}}

    /* Link-styled button */
    .btn-link{
      display:block;
      width:100%;
      padding:11px 12px;
      margin-top:14px;
      font-size:14px;
      border-radius:10px;
      text-decoration:none;
      border:1px solid rgba(48,173,247,35);
      background:rgba(48,173,247,12);
      color:var(--brand-navy);
      font-weight:700;
      text-align:center;
    }
    .btn-link:hover{filter:brightness(.98)}
    .hint{ font-size:12px;color:var(--muted);margin-top:10px; }

    /* Custom dropdown */
    .dd { position: relative; margin-top: 7px; }
    .dd-btn{
      width:100%;
      padding:11px 12px;
      font-size:14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
    }
    .dd-btn:focus{
      outline:none;
      border-color:rgba(48,173,247,8);
      box-shadow:0 0 0 4px rgba(48,173,247,18);
    }
    .dd-caret{ color: var(--muted); font-size: 12px; }
    .dd-menu{
      position:absolute;
      top:calc(100% + 6px);
      left:0;
      right:0;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 18px 45px rgba(17,24,39,12);
      max-height:240px;
      overflow:auto;
      padding:6px;
      z-index:9999;
      display:none;
    }
    .dd.open .dd-menu{ display:block; }
    .dd-item{
      width:100%;
      border:none;
      background:transparent;
      padding:10px 10px;
      border-radius:10px;
      text-align:left;
      cursor:pointer;
      color:var(--text);
      font-size:14px;
    }
    .dd-item:hover{ background:rgba(48,173,247,10); }
    .dd-meta{ font-size:11px; color:var(--muted); margin-top:2px; }
    .dd-search{
      width:100%;
      padding:10px 10px;
      margin:6px 0 8px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:13px;
    }
  </style>
</head>

<body
  data-page-title="CSV Upload"
  data-page-badge="Partner / Batch Ingest"
  data-page-help="Uploads a CSV to Storage and creates an ingest_jobs record."
>

  <div class="wrap">

    <div id="siteNav"></div>
  <button id="logoutBtn" type="button" style="display:none;">Logout</button>
    
    <div class="card" id="loginCard">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" autocomplete="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" autocomplete="current-password" />
        </div>
      </div>
      <button class="btn" id="loginBtn">Sign in</button>
      <div class="status" id="loginStatus"></div>
      <div class="hint">If login works but dropdowns donâ€™t load, itâ€™s usually RLS.</div>
    </div>

    <div class="card" id="appCard" style="display:none;">
      <div class="row">
        <div>
          <label>Client</label>
          <div class="dd" id="ddClient"></div>
        </div>
        <div>
          <label>Campaign</label>
          <div class="dd" id="ddCampaign"></div>
        </div>
      </div>

      <label>Source</label>
      <div class="dd" id="ddSource"></div>

      <a class="btn-link" href="./abm-logic-lead-upload-template.csv" download>
        Download CSV Template
      </a>

      <label>CSV File</label>
      <input id="file" type="file" accept=".csv" />

      <button class="btn" id="uploadBtn">Upload CSV</button>
      <div class="status" id="status"></div>
      <div class="hint">Storage path: <code>client_{id}/campaign_{id}/ingest_{job_id}.csv</code></div>
    </div>
  </div>

  <!-- Shared Nav -->
  <script src="/abm-upload/nav.js?v=11" defer></script>

  <script>
    // ===== CONFIG =====
    // Supabase anon public key (OK to be in frontend)
    window.ABM_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13Zm5ibWtqZXRyaXVuc2RkdXByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzY0MDcsImV4cCI6MjA4MjA1MjQwN30._mPr3cn9Dse-oOB44AlFTDq8zjgUkIhCZG31gzeYmHU";
    const SUPABASE_URL = "https://mwfnbmkjetriunsddupr.supabase.co";
    // ==================

    if (!window.supabase) {
      alert("Supabase SDK failed to load (cdn.jsdelivr). Check network / extensions.");
      throw new Error("Supabase SDK not loaded");
    }

    // Create client
    const sb = window.supabase.createClient(SUPABASE_URL, window.ABM_SUPABASE_ANON_KEY);

    // Make it available for nav.js logout if you want it later
    window.ABM = window.ABM || {};
    window.ABM.sb = sb;

    const $ = (id) => document.getElementById(id);

    // Dropdown state
    const state = {
      client:   { value: "", label: "Select clientâ€¦", items: [] },
      campaign: { value: "", label: "Select campaignâ€¦", items: [] },
      source:   { value: "", label: "Select sourceâ€¦", items: [] }
    };

    // Raw caches (used for filtering campaigns by selected client)
    const cache = { clients: [], campaigns: [], sources: [] };

    $("loginBtn").addEventListener("click", login);
    $("uploadBtn").addEventListener("click", uploadCsv);

    // Close dropdowns when clicking outside
    document.addEventListener("click", (e) => {
      ["ddClient","ddCampaign","ddSource"].forEach(id => {
        const el = $(id);
        if (!el) return;
        if (!el.contains(e.target)) el.classList.remove("open");
      });
    });

    function renderDropdown(containerId, key, placeholder) {
      const container = $(containerId);
      container.innerHTML = "";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "dd-btn";
      btn.innerHTML = `<span>${state[key].label || placeholder}</span><span class="dd-caret">â–¾</span>`;
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        container.classList.toggle("open");
        const search = container.querySelector(".dd-search");
        if (search) {
          search.value = "";
          search.focus();
          filterMenu(containerId, key, "");
        }
      });

      const menu = document.createElement("div");
      menu.className = "dd-menu";

      const search = document.createElement("input");
      search.className = "dd-search";
      search.placeholder = "Type to filterâ€¦";
      search.addEventListener("input", () => filterMenu(containerId, key, search.value));
      menu.appendChild(search);

      const list = document.createElement("div");
      list.className = "dd-list";
      menu.appendChild(list);

      container.appendChild(btn);
      container.appendChild(menu);

      filterMenu(containerId, key, "");
    }

    function filterMenu(containerId, key, query) {
      const container = $(containerId);
      const list = container.querySelector(".dd-list");
      if (!list) return;

      const q = (query || "").toLowerCase().trim();
      list.innerHTML = "";

      const items = (state[key].items || []).filter(it =>
        !q || (it.label || "").toLowerCase().includes(q)
      );

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "dd-meta";
        empty.style.padding = "10px";
        empty.textContent = "No matches.";
        list.appendChild(empty);
        return;
      }

      for (const it of items) {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "dd-item";
        b.textContent = it.label;

        b.addEventListener("click", () => {
          state[key].value = it.value;
          state[key].label = it.label;
          container.classList.remove("open");

          if (key === "client") {
            applyCampaignFilterForSelectedClient();
            renderDropdown("ddCampaign", "campaign", "Select campaignâ€¦");
          }

          renderDropdown(containerId, key, "");
        });

        list.appendChild(b);
      }
    }

    function applyCampaignFilterForSelectedClient() {
      const clientId = state.client.value;

      state.campaign.label = "Select campaignâ€¦";
      state.campaign.value = "";

      if (!clientId) {
        state.campaign.items = [];
        return;
      }

      const filtered = (cache.campaigns || []).filter(c => c.client_id === clientId);
      state.campaign.items = filtered.map(r => ({ value: r.campaign_id, label: r.name }));
    }

    async function login() {
      $("loginStatus").textContent = "Signing inâ€¦";
      const { error } = await sb.auth.signInWithPassword({
        email: $("email").value.trim(),
        password: $("password").value
      });
      if (error) {
        $("loginStatus").textContent = error.message;
        return;
      }
      $("loginStatus").textContent = "";
      showApp();
    }
async function logout() {
  try {
    await sb.auth.signOut();
  } catch (e) {
    console.warn("Logout error:", e);
  }
  location.href = "/abm-upload/index.html";
}

    $("logoutBtn")?.addEventListener("click", logout);
    
    async function showApp() {
      const loginCard = $("loginCard");
        // Set navbar identity AFTER login, then refresh navbar
  const { data: userRes } = await sb.auth.getUser();
  if (userRes?.user?.email) {
    window.ABM_USER_EMAIL = userRes.user.email;
    window.ABM_ROLE = "ops";
    window.dispatchEvent(new Event("abm:nav:refresh"));
  }

      const appCard = $("appCard");
      const status = $("status");

      if (loginCard) loginCard.style.display = "none";
      if (appCard) appCard.style.display = "block";
      if (status) status.textContent = "Loading dropdownsâ€¦";

      try {
        await loadItems();

        state.client.label = "Select clientâ€¦";
        state.client.value = "";
        state.campaign.label = "Select campaignâ€¦";
        state.campaign.value = "";
        state.source.label = "Select sourceâ€¦";
        state.source.value = "";

        state.client.items = (cache.clients || []).map(r => ({ value: r.client_id, label: r.name }));
        state.source.items = (cache.sources || []).map(r => ({ value: r.source_id, label: r.source_name }));
        state.campaign.items = [];

        renderDropdown("ddClient", "client", "Select clientâ€¦");
        renderDropdown("ddCampaign", "campaign", "Select campaignâ€¦");
        renderDropdown("ddSource", "source", "Select sourceâ€¦");

        if (status) status.textContent = "";
      } catch (e) {
        if (status) status.textContent = String(e?.message || e);
      }
    }

    async function loadItems() {
      const { data: clients, error: cErr } = await sb
        .from("clients")
        .select("client_id, name")
        .order("name");
      if (cErr) throw new Error(`Failed to load clients: ${cErr.message}`);

      const { data: campaigns, error: caErr } = await sb
        .from("campaigns")
        .select("campaign_id, client_id, name, type, status")
        .order("name");
      if (caErr) throw new Error(`Failed to load campaigns: ${caErr.message}`);

      const { data: sources, error: sErr } = await sb
        .from("sources")
        .select("source_id, source_name, source_system, source_channel")
        .order("source_name");
      if (sErr) throw new Error(`Failed to load sources: ${sErr.message}`);

      cache.clients = clients || [];
      cache.campaigns = campaigns || [];
      cache.sources = sources || [];
    }

    async function uploadCsv() {
      const file = $("file")?.files?.[0];
      const status = $("status");
      if (!file) { if (status) status.textContent = "Select a CSV first."; return; }

      if (!state.client.value || !state.campaign.value || !state.source.value) {
        if (status) status.textContent = "Select Client, Campaign, and Source first.";
        return;
      }

      if (status) status.textContent = "Checking sessionâ€¦";
      const { data:{user}, error:userErr } = await sb.auth.getUser();
      if (userErr || !user) { if (status) status.textContent = "Not logged in."; return; }

      if (status) status.textContent = "Creating ingest jobâ€¦";
      const { data: job, error: jobErr } = await sb
        .from("ingest_jobs")
        .insert({
          client_id: state.client.value,
          campaign_id: state.campaign.value,
          source_id: state.source.value,
          status: "uploaded",
          storage_bucket: "ingest-uploads",
          created_by: user.id
        })
        .select("id")
        .single();

      if (jobErr) { if (status) status.textContent = `Failed to create ingest job: ${jobErr.message}`; return; }

      const path = `client_${state.client.value}/campaign_${state.campaign.value}/ingest_${job.id}.csv`;

      if (status) status.textContent = "Uploading fileâ€¦";
      const { error: upErr } = await sb.storage
        .from("ingest-uploads")
        .upload(path, file, { upsert:true, contentType:"text/csv" });

      if (upErr) { if (status) status.textContent = `Upload failed: ${upErr.message}\nJob created: ${job.id}`; return; }

      if (status) status.textContent = "Updating job recordâ€¦";
      const { error: updErr } = await sb
        .from("ingest_jobs")
        .update({ storage_path: path })
        .eq("id", job.id);

      if (updErr) { if (status) status.textContent = `Upload ok but update failed: ${updErr.message}`; return; }

      if (status) status.textContent = `âœ… Upload complete\nJob ID: ${job.id}\nPath: ${path}\nðŸš€ Starting ingestionâ€¦`;

      // Trigger process-ingest-job Edge Function with JWT + apikey
      try {
        const { data: sess } = await sb.auth.getSession();
        const jwt = sess?.session?.access_token;

        const resp = await fetch(`${SUPABASE_URL}/functions/v1/process-ingest-job`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": window.ABM_SUPABASE_ANON_KEY,
            ...(jwt ? { "Authorization": "Bearer " + jwt } : {})
          },
          body: JSON.stringify({ ingest_job_id: job.id })
        });

        const text = await resp.text();

        if (!resp.ok) {
          if (status) status.textContent += `\nâŒ Ingestion failed (${resp.status})\n${text}`;
          return;
        }

        if (status) status.textContent += `\nâœ… Ingestion completed\n${text}`;
      } catch (e) {
        if (status) status.textContent += `\nâŒ Ingestion call failed\n${String(e?.message || e)}`;
      }
    }

    // Auto-show app if already logged in
    sb.auth.getSession()
      .then(r => { if (r?.data?.session) showApp(); })
      .catch(()=>{});
  </script>

  
</body>
</html>





